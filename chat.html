<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <link rel="stylesheet" type="text/css" href="chat.css">
</head>
<body>
  <div id="chatContainer">
    <div id="messageContainer"></div>
    <div id="messageInput">
      <input type="text" id="messageText" placeholder="Type a message">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    // Firebase configuration
    firebase.initializeApp({
      apiKey: "AIzaSyDB2sNW2w-kvwOaqYJ-6Pojd79j1rRzgDw",
      authDomain: "chat-71251.firebaseapp.com",
      databaseURL: "https://chat-71251-default-rtdb.firebaseio.com",
      projectId: "chat-71251",
      storageBucket: "chat-71251.appspot.com",
      messagingSenderId: "290327153997"
    });

    var database = firebase.database();
    var messagesRef = database.ref('messages');
    var userUUID = getUserUUID();
    var messageContainer = document.getElementById('messageContainer');
    var messageText = document.getElementById('messageText');

    function getUserUUID() {
      var uuid = "";
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.startsWith("userUUID=")) {
          uuid = cookie.substring("userUUID=".length);
          break;
        }
      }
      return uuid;
    }

    function loadMessages() {
      messagesRef.orderByChild('timestamp').once('value', function(snapshot) {
        var messages = [];
        snapshot.forEach(function(childSnapshot) {
          var messageData = childSnapshot.val();
          messages.push({ id: childSnapshot.key, ...messageData });
        });

        messages.sort((a, b) => a.timestamp - b.timestamp); // Sort messages by timestamp (oldest first)

        // Render messages
        messageContainer.innerHTML = ''; // Clear existing messages
        messages.forEach(message => {
          var messageElement = document.createElement('div');
          messageElement.classList.add('message');
          if (message.senderUUID === userUUID) {
            messageElement.classList.add('my-message');
          } else {
            messageElement.classList.add('other-message');
          }
          messageElement.textContent = message.text;
          messageContainer.appendChild(messageElement);
        });

        // Scroll to the bottom
        messageContainer.scrollTop = messageContainer.scrollHeight;
      });
    }

    function sendMessage() {
      var text = messageText.value.trim();
      if (text) {
        var newMessageRef = messagesRef.push();
        newMessageRef.set({
          text: text,
          senderUUID: userUUID,
          timestamp: Date.now()
        }, function(error) {
          if (error) {
            alert("Error sending message.");
          } else {
            messageText.value = ''; // Clear input field
            loadMessages(); // Reload messages after sending
          }
        });
      }
    }

    // Load messages on page load
    loadMessages();
  </script>
</body>
</html>
