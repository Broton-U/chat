<!DOCTYPE html>
<html>
<head>
  <title>Who Dis</title>
  <link rel="stylesheet" type="text/css" href="login.css">
</head>
<body>
  <div id="loginSignupContainer">
    <div id="loginForm" class="form-container">
      <h2>Login</h2>
      <label for="loginName">Name:</label>
      <input type="text" id="loginName" name="loginName" placeholder="Enter your name">
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" placeholder="Enter your password">
      <button onclick="login()">Login</button>
      <button onclick="showSignup()">Sign Up</button>
    </div>

    <div id="signupForm" class="form-container" style="display: none;">
      <h2>Sign Up</h2>
      <label for="signupName">Name:</label>
      <input type="text" id="signupName" name="signupName" placeholder="Enter your name">
      <label for="signupPassword">Password:</label>
      <input type="password" id="signupPassword" name="signupPassword" placeholder="Enter your password">
      <button onclick="signup()">Sign Up</button>
      <button onclick="showLogin()">Login</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="login.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      function getUserUUID() {
        var uuid = "";
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.startsWith("userUUID=")) {
            uuid = cookie.substring("userUUID=".length);
            break;
          }
        }
        return uuid;
      }

      var uuid = getUserUUID();
      if (uuid) {
        window.location.href = 'chat.html';
      }

      // Firebase configuration
      var firebaseConfig = {
        apiKey: "your-api-key",
        authDomain: "your-auth-domain",
        projectId: "your-project-id",
        storageBucket: "your-storage-bucket",
        messagingSenderId: "your-messaging-sender-id",
        appId: "your-app-id",
        databaseURL: "your-database-url"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      var database = firebase.database();
      var usersRef = database.ref('users');

      function showLogin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('signupForm').style.display = 'none';
      }

      function showSignup() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('signupForm').style.display = 'block';
      }

      function login() {
        var loginName = document.getElementById('loginName').value.trim();
        var password = document.getElementById('password').value.trim();
        if (loginName && password) {
          var lowerCaseName = loginName.toLowerCase();
          authenticateUser(lowerCaseName, password, function(success, userUUID) {
            if (success) {
              document.cookie = "userUUID=" + userUUID + ";path=/";
              window.location.href = 'chat.html';
            } else {
              alert("Invalid name or password.");
            }
          });
        } else {
          alert("Please enter both name and password.");
        }
      }

      function signup() {
        var signupName = document.getElementById('signupName').value.trim();
        var signupPassword = document.getElementById('signupPassword').value.trim();
        if (signupName && signupPassword) {
          var lowerCaseName = signupName.toLowerCase();
          checkUserName(lowerCaseName, function(exists) {
            if (exists) {
              alert("Name taken, please choose another.");
            } else {
              var userUUID = generateUUID();
              document.cookie = "userUUID=" + userUUID + ";path=/";
              usersRef.child(userUUID).set({
                name: signupName,
                nameLower: lowerCaseName,
                role: "default",
                password: signupPassword
              }, function(error) {
                if (error) {
                  alert("Error creating user.");
                } else {
                  window.location.href = 'chat.html';
                }
              });
            }
          });
        } else {
          alert("Please enter both name and password.");
        }
      }

      function checkUserName(userName, callback) {
        var query = usersRef.orderByChild('nameLower').equalTo(userName);
        query.once('value', function(snapshot) {
          callback(snapshot.exists());
        });
      }

      function authenticateUser(userName, password, callback) {
        var query = usersRef.orderByChild('nameLower').equalTo(userName);
        query.once('value', function(snapshot) {
          if (snapshot.exists()) {
            snapshot.forEach(function(childSnapshot) {
              var userData = childSnapshot.val();
              if (userData.password === password) {
                callback(true, childSnapshot.key);
              } else {
                callback(false, null);
              }
            });
          } else {
            callback(false, null);
          }
        });
      }

      function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      window.login = login;
      window.signup = signup;
      window.showLogin = showLogin;
      window.showSignup = showSignup;
    });
  </script>
</body>
</html>
